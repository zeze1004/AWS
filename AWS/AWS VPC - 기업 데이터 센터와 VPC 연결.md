# VPC



대부분의 기업은 웹, 앱, 디비 3계층으로 구분되는 3계층은 서로 연결 되어 있음

기업의 OLTP(Online Transactions Pocessing) 시스템은 데이터 웨어하우스 시스템과 상호작용할 수 있어야 하고 특정 앱은 방화벽 뒤에 은폐되야하고 다른 일부는 인터넷에 공개되어야 하는 반면 DB 계층은 프라이빗 서브넷 속에 있어야 함



### 기업의 고민

기업은 서버의 IP 주소를 바꾸면 지정된 서버와 소통이 불가능

그렇다면 기업의 인프라를 어떻게 클라우드로 이전할까? 기업 데이터 센터에 있는 애플리캐이션은 어떤 방법으로 클라우드와 연결될 수 있는가? 클라우드에서 어떻게 네트워크를 분리할 것인가? 일부는 인터넷을 통해 연결하고 일부는 프라이빗 서브넷을 통해 연결할 수 있는가?



VPC 생기기 이전

- 클라우드에 있는 리소스 격리할 수 있는 방법이 없었음
- 수천 대의 서버의 IP 네임스페이스를 정확히 관리했어야 하며, IP 주소가 중복되면 온프레미스에서 구동되는 리소스에 접근 불가



### VPC가 생긴 후 기업의 고민을 해결할 수 있었음

- VPC가 기업의 클라우드 데이터 센터 구현 체계이며 VPN, Direct Connect 등과 결함하면 기존 데이터 센터를 클라우드로 확장 가능

  - Direct Connect를 이용해 기업 데이터 센터와 VPN 전용 회선으로 연결 가능

  - 암호화된 IPsec 연결을 통해 하드웨어 기반 VPN으로 기업 데이터 센터 연결 가능

- 어플리케이션 중 일부는 VPC 내 클라우드 실행, 일부는 온프레미스에서 실행

- EC2 인스턴스를 론칭하면 32비트 랜덤 IP 주소를 부여받는데 기존 데이터센터 IP 주소 체계와 비슷하게 유지 가능

- 자체 ip 주소/범위, 프라이빗/퍼블릭 서브넷, 라우트 테이블, 네트워크 게이트웨이 등 모든 기능 활용

- VPC 내에서 다수의 서브넷 생성 가능

  - 인터넷 접급을 위한 퍼블릭 서브넷, 격리된 접근을 위한 프라이빗 서브넷 생성
  - VPC의 퍼블릭 서브넷으로 웹 계층 실행, 프라이빗 서브넷으로 DB 계층 실행으로 3계층 구조 유지

- 네트워크 통제권 가짐

- 하나 이상의 VPC가 필요하다면 다수의 VPC 생성 후 VPC 피어링을 통해 서로 연결 가능

- VPC 엔드포인트를 사용해 S3와 같은 리소스에 연결 가능



### VPC 구성 요소와 주요 용어

#### CIDR

CIDR 블록을 이용한 CIDR 범위 결정

- 아마존은 IPv4/6 모두 제공
- IPv6의 ip 범위는 선택할 수 없지만 IPv4의 주소 범위 지정은 필수 사항
- 한 번 생성된 VPC 주소 크기는 변경X
  - 더 큰 주소 필요시  새로운 VPC 생성 + 마이그레이션하는 불편함 동반

#### 리전

- 리전 선택 후 다른 리전으로 확장x

- VPC 내에서 동일 리전의 AZ 포함 가능



#### 서브넷

- Subnet(부분망) 이란 하나의 IP 네트워크 주소를 네트워크 내부에서 

  적절히 분할하여 다수의 상호 연결된 하부 네트워크로 나누어 사용하는 방법

  https://dev.classmethod.jp/articles/vpc-3/

- 하나의 VPC에 세 개의 AZ가 있는 경우 각각의 AZ마다 별도의 서브넷 생성

- 서브넷 생성시 VPC의 CICD(프리픽스) 블록에 맞춰야 함

- AWS가 확보한 서브넷 중 처음 4개의 IP 주소와 마지막 IP 주소는 인터넷 네트워킹을 위해 예약돼있음

  - EX) 10.0.0.0/24 체계의 CIDR 블록이 있는 서브넷에서 10.0.0.0, 10.0.0.1, 10.0.0.2, 10.0.0.3, 10.0.0.255 5개의 IP 주소는 예약



### 라우트 테이블

- 트래픽 전송 방향을 결정하는 라우트와 관련된 규칙을 담은 테이블
- 모든 서브넷은 라우트 테이블을 지님
  - 각각의 서브넷은 항상 라우트 테이블을 가지고 있어야 하지만, 하나의 라우트 테이블 규칙을 여러 서브넷과 연결하는 것은 가능
  - 서브넷 생성 후 별도로 라우트 테이블 생성하지 않으면 디폴트 라우트 테이블로 연결
    - 디폴트 라우트 테이블은 자동으로 생성되며 수정 X
    - IPv4 대응이 기본이므로 IPv6에 대응하는 라우트 테이블은 따로 만들어야 함

